<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lingua Magica · 极简主页</title>
  <meta name="description" content="极简魔法主页：只展示咒语与解析，内容来自仓库里的 spells.json。" />
  <style>
    :root{--fg:#111;--bg:#fff;--muted:#666;--border:#ddd}
    @media(prefers-color-scheme:dark){:root{--fg:#fafafa;--bg:#0b0b0b;--muted:#aaa;--border:#222}}
    *{box-sizing:border-box}html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--fg);background:var(--bg)}
    .wrap{max-width:760px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:10px 0 6px}
    p.desc{margin:0 0 16px;color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .block{border:1px solid var(--border);padding:12px;border-radius:10px;background:transparent;white-space:pre-wrap}
    details{border:1px dashed var(--border);border-radius:10px;padding:10px}
    summary{cursor:pointer;color:var(--muted)}
    footer{margin-top:32px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between}
    .muted{color:var(--muted)}
    .hidden{display:none}
    form.add{border:1px dashed var(--border);border-radius:12px;padding:12px;margin:10px 0}
    form.add input, form.add textarea{width:100%;border:1px solid var(--border);background:transparent;border-radius:10px;padding:10px;margin-top:6px;color:inherit}
    form.add textarea{min-height:100px}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Lingua Magica · 极简主页</h1>
    <p class="desc">下方所有咒语均直接来自仓库根目录的 <code class="mono">spells.json</code>，不是本地缓存。</p>

    <!-- 动态列表挂载点 -->
    <div id="spells"></div>

    <!-- 轻量添加表单（直接更新内存并提供一键下载 JSON，便于你提交到仓库） -->
    <form id="addForm" class="add">
      <strong>添加咒语（编辑后点“下载 JSON”，将文件替换仓库里的 <span class="mono">spells.json</span>）</strong>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">标题</label>
      <input id="fTitle" placeholder="例如：观看护符"/>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">咒语正文</label>
      <textarea id="fBody" placeholder="填写具体咒语文本"></textarea>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">解析</label>
      <textarea id="fAnalysis" placeholder="如何使用、注意事项、背景原理等"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addBtn">添加到当前列表</button>
        <button class="btn" id="downloadBtn" type="button">下载 JSON</button>
        <span class="muted" id="hint"></span>
      </div>
    </form>

    <footer>
      <span>© <span id="year"></span> Lingua Magica</span>
      <div>
        <a href="./index.html">主页</a> · <a href="./admin.html">管理员入口</a>
      </div>
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // 读取 spells.json
    const mount = document.getElementById('spells');
    let data = [];

    async function loadSpells(){
      try{
        const res = await fetch('./spells.json', {cache:'no-cache'});
        if(!res.ok) throw new Error('无法读取 spells.json');
        data = await res.json();
        render();
      }catch(e){
        mount.innerHTML = `<p class='muted'>读取 <span class='mono'>spells.json</span> 失败：${e.message}。请确认该文件已放在仓库根目录并允许被 Pages 访问。</p>`;
      }
    }

    function render(){
      mount.innerHTML = '';
      if(!Array.isArray(data) || !data.length){
        mount.innerHTML = `<div class='card muted'>（当前还没有咒语，请添加后下载 JSON 上传到仓库）</div>`; return;
      }
      data.forEach(s=>{
        const sec = document.createElement('section');
        sec.className = 'card';
        sec.innerHTML = `
          <h2 style="margin:0 0 8px; font-size:18px;">${s.title||'未命名咒语'}</h2>
          <div class="block mono">${(s.body||'').replace(/\n/g,'\n')}</div>
          ${s.analysis ? `<details style="margin-top:8px"><summary>解析 · Explanation</summary><div class="block" style="margin-top:8px">${(s.analysis||'').replace(/\n/g,'<br>')}</div></details>`: ''}
        `;
        mount.appendChild(sec);
      });
    }

    // 添加 + 下载 JSON（用于提交到仓库）
    const addBtn = document.getElementById('addBtn');
    const dlBtn = document.getElementById('downloadBtn');
    const hint = document.getElementById('hint');

    addBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const title = document.getElementById('fTitle').value.trim();
      const body = document.getElementById('fBody').value.trim();
      const analysis = document.getElementById('fAnalysis').value.trim();
      if(!body){ alert('请填写咒语正文'); return; }
      const id = `w-${Date.now().toString(36)}`;
      const item = { id, title, body, analysis, createdAt: new Date().toISOString() };
      data = Array.isArray(data)? [item, ...data] : [item];
      render();
      hint.textContent = '已添加到当前页面，请点击“下载 JSON”并替换仓库中的 spells.json';
      setTimeout(()=>hint.textContent='', 3000);
      document.getElementById('fTitle').value='';
      document.getElementById('fBody').value='';
      document.getElementById('fAnalysis').value='';
    });

    dlBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'spells.json';
      a.click();
    });

    loadSpells();
  </script>
</body>
</html>
