<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lingua Magica · 极简主页（自动发布）</title>
  <meta name="description" content="主页直接读取与编辑仓库根目录 spells.json，可一键提交到 GitHub（无安全，所有人可改）。" />
  <style>
    :root{--fg:#111;--bg:#fff;--muted:#666;--border:#ddd;--ok:#0a7;--bad:#b22}
    @media(prefers-color-scheme:dark){:root{--fg:#fafafa;--bg:#0b0b0b;--muted:#aaa;--border:#222}}
    *{box-sizing:border-box}html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--fg);background:var(--bg)}
    .wrap{max-width:820px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:10px 0 6px}
    p.desc{margin:0 0 12px;color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:transparent;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:var(--ok);color:var(--ok)}
    .btn.danger{border-color:var(--bad);color:var(--bad)}
    .btn:active{transform:translateY(1px)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .block{border:1px solid var(--border);padding:12px;border-radius:10px;background:transparent;white-space:pre-wrap}
    details{border:1px dashed var(--border);border-radius:10px;padding:10px}
    summary{cursor:pointer;color:var(--muted)}
    footer{margin-top:32px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between}
    .muted{color:var(--muted)}
    form.add{border:1px dashed var(--border);border-radius:12px;padding:12px;margin:10px 0}
    form.add input, form.add textarea{width:100%;border:1px solid var(--border);background:transparent;border-radius:10px;padding:10px;margin-top:6px;color:inherit}
    form.add textarea{min-height:100px}
    .warn{border:1px solid rgba(178,34,34,.35);background:rgba(178,34,34,.06);color:#b22;border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Lingua Magica · 极简主页（自动发布）</h1>
    <p class="desc">本页直接从仓库根目录 <span class="mono">spells.json</span> 读取并渲染所有咒语；你也可以在下方添加新咒语并<strong>一键提交</strong>到 GitHub。</p>

    <!-- ⚠️ 极简说明：此方案将写入令牌暴露在前端，任何人都可提交到仓库。仅作演示使用。 -->
    <div class="warn card">
      <strong>⚠️ 无安全版（所有人可编辑）</strong>
      <div style="margin-top:6px">把你的 <em>Fine-grained PAT</em> 粘进输入框即可（<span class="mono">contents:write</span> 对本仓库）。令牌将暴露给所有访问者，滥用风险极高——请仅用于演示仓库。</div>
      <div class="row" style="margin-top:8px">
        <input id="token" class="mono" placeholder="在此粘贴 GitHub Token（例如：github_pat_... 或 ghp_...）" style="flex:1" />
        <button class="btn" id="saveTok">保存到本地</button>
        <button class="btn danger" id="clearTok">清除本地令牌</button>
      </div>
    </div>

    <!-- 动态列表挂载点 -->
    <div id="spells"></div>

    <!-- 添加并直接发布到 GitHub（覆盖 spells.json） -->
    <form id="addForm" class="add">
      <strong>添加新咒语（发布到仓库）</strong>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">标题</label>
      <input id="fTitle" placeholder="例如：观看护符"/>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">咒语正文</label>
      <textarea id="fBody" placeholder="填写具体咒语文本"></textarea>
      <label style="display:block;margin-top:8px;font-size:12px;color:var(--muted)">解析</label>
      <textarea id="fAnalysis" placeholder="如何使用、注意事项、背景原理等"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addBtn">添加到当前页面</button>
        <button class="btn primary" id="publishBtn" type="button">发布到 GitHub</button>
        <span class="muted" id="hint"></span>
      </div>
    </form>

    <footer>
      <span>© <span id="year"></span> Lingua Magica</span>
      <div>
        <a href="./index.html">主页</a> · <a href="./admin.html">管理员入口</a>
      </div>
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // —— 配置：你的仓库信息 ——
    const OWNER = 'Daiyiii';
    const REPO  = 'lingua_magica';
    const BRANCH = 'main';

    // 令牌本地存储（明文）
    const tokenInput = document.getElementById('token');
    const saveTok = document.getElementById('saveTok');
    const clearTok = document.getElementById('clearTok');
    const TOK_KEY = 'lm_pub_token';
    tokenInput.value = localStorage.getItem(TOK_KEY)||'';
    saveTok.addEventListener('click', ()=>{ localStorage.setItem(TOK_KEY, tokenInput.value.trim()); alert('已保存到本地'); });
    clearTok.addEventListener('click', ()=>{ localStorage.removeItem(TOK_KEY); tokenInput.value=''; alert('已清除'); });

    // 渲染咒语列表
    const mount = document.getElementById('spells');
    let data = [];

    async function loadSpells(){
      try{
        // 直接从 Pages 根目录加载
        const res = await fetch('./spells.json', {cache:'no-cache'});
        if(!res.ok) throw new Error('无法读取 spells.json');
        data = await res.json();
        render();
      }catch(e){
        mount.innerHTML = `<p class='muted'>读取 <span class='mono'>spells.json</span> 失败：${e.message}</p>`;
      }
    }

    function render(){
      mount.innerHTML = '';
      if(!Array.isArray(data) || !data.length){
        mount.innerHTML = `<div class='card muted'>（当前还没有咒语）</div>`; return;
      }
      data.forEach(s=>{
        const sec = document.createElement('section');
        sec.className = 'card';
        sec.innerHTML = `
          <h2 style="margin:0 0 8px; font-size:18px;">${s.title||'未命名咒语'}</h2>
          <div class="block mono">${(s.body||'').replace(/\n/g,'\n')}</div>
          ${s.analysis ? `<details style="margin-top:8px"><summary>解析 · Explanation</summary><div class="block" style="margin-top:8px">${(s.analysis||'').replace(/\n/g,'<br>')}</div></details>`: ''}
        `;
        mount.appendChild(sec);
      });
    }

    // 添加到内存
    const addBtn = document.getElementById('addBtn');
    const hint = document.getElementById('hint');
    addBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const title = document.getElementById('fTitle').value.trim();
      const body = document.getElementById('fBody').value.trim();
      const analysis = document.getElementById('fAnalysis').value.trim();
      if(!body){ alert('请填写咒语正文'); return; }
      const id = `w-${Date.now().toString(36)}`;
      const item = { id, title, body, analysis, createdAt: new Date().toISOString() };
      data = Array.isArray(data)? [item, ...data] : [item];
      render();
      hint.textContent = '已添加到当前页面，点击“发布到 GitHub”可写入仓库';
      setTimeout(()=>hint.textContent='', 3000);
      document.getElementById('fTitle').value='';
      document.getElementById('fBody').value='';
      document.getElementById('fAnalysis').value='';
    });

    // 发布到 GitHub（覆盖 spells.json）
    const publishBtn = document.getElementById('publishBtn');

    function encBase64(str){
      // UTF-8 安全 Base64
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    }

    async function getFileSha(path){
      const tok = localStorage.getItem(TOK_KEY)||tokenInput.value.trim();
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${BRANCH}`;
      const res = await fetch(url, { headers: { 'Accept':'application/vnd.github+json', 'Authorization': `Bearer ${tok}` } });
      if(res.status===404){ return null; }
      if(!res.ok){ throw new Error('获取文件信息失败'); }
      const json = await res.json();
      return json.sha;
    }

    async function putFile(path, content, message){
      const tok = localStorage.getItem(TOK_KEY)||tokenInput.value.trim();
      if(!tok){ alert('请先粘贴 GitHub Token'); return; }
      const sha = await getFileSha(path); // 可能为 null（新建）
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}`;
      const body = {
        message,
        content: encBase64(content),
        branch: BRANCH,
        sha: sha || undefined
      };
      const res = await fetch(url, {
        method:'PUT',
        headers: {
          'Accept':'application/vnd.github+json',
          'Authorization': `Bearer ${tok}`
        },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`提交失败：${res.status} ${t}`);
      }
      return res.json();
    }

    publishBtn.addEventListener('click', async ()=>{
      try{
        const jsonText = JSON.stringify(data, null, 2);
        await putFile('spells.json', jsonText, 'chore: update spells.json via web editor');
        alert('已发布到 GitHub：spells.json');
        await loadSpells();
      }catch(e){
        alert(e.message||e);
      }
    });

    loadSpells();
  </script>
</body>
</html>
